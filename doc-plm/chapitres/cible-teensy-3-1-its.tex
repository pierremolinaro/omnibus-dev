%!TEX encoding = UTF-8 Unicode
%!TEX root = ../doc-plm.tex





\chapter{Cible \texttt{teensy-3-1-it}}\index{Cible!\texttt{teensy-3-1-it}}

Dans l'état actuel de PLM, une seule cible est définie : \texttt{teensy-3-1-it}.  Elle permet une programmation séquentielle avec routines d'interruption. L'interruption \texttt{systick} est programmée pour se déclencher chaque milliseconde. L'objet de ce chapitre est de décrire son utilisation.

Il est possible de définir sa propre cible (\refChapterPage{chapitreConfCible}).




















\sectionLabel{Organigramme d'exécution}{organigrammeExecutionTeensy31It}

La \refFigure{}{sequenceDemarrageTeensySequentialSystick} définit l'organigramme d'exécution d'un programme.

Le micro-contrôleur démarre sur une horloge interne, la mémoire vive n'étant pas initialisée. Il est dans le mode \emph{thread, priviliged access}, avec une seule pile. La configuration conservera cette pile unique, jusqu'au démarrage des tâches.

La première étape est de configurer les horloges internes du micro-contrôleur : c'est le rôle des routines \plm=boot= (\refSectionPage{personalisationDemarrageTeensy31it}). À ce stade, la mémoire vive n'est toujours pas initialisée, aussi les routines \plm=boot= n'y accèdent pas (le compilateur l'assure).

La deuxième étape est d'initialiser les \emph{variables globales}, c'est-à-dire mettre à zéro la zone \texttt{bss}, et de recopier à partir de la flash les valeurs initiales des variables initialisées.

La troisième étape est l'exécution des routines \plm=init= (\refSectionPage{personalisationInitTeensy31it}). À partir de cette étape et pour les suivantes, les variables globales sont initialisées, et donc leur emploi est autorisé. Le rôle des routines \plm=init= est de configurer les entrées/sorties du micro-contrôleur.

Ensuite, les tâches sont lancées, et exécutées en fonction de leurs priorités et synchronisations.


\begin{figure}[t]
  \centering
  \small
  \begin{tikzpicture}[
      cloud/.style ={draw=red, thick, ellipse,fill=red!20, minimum height=2em},
      block/.style ={rectangle, draw=blue, thick, fill=green!20, align=center},
      decision/.style={chamfered rectangle, draw=blue, thick, fill=green!20},
      node distance=5mm
    ]
    \node [cloud] (start) {\textsc{Démarrage du micro-contrôleur}} ;
    \node [block] (boot) [below=of start] {Routines \bf\texttt{boot}} ;
    \node [block] (raz) [below=of boot] {Initialisation des variables globales} ;
    \node [block] (init) [below=of raz] {Routines \bf\texttt{init}} ;
    \node [block] (setup) [below=of init] {Démarrage des tâches} ;

    \draw [-stealth, thick] (start) -- (boot) ;
    \draw [-stealth, thick] (boot) -- (raz) ;
    \draw [-stealth, thick] (raz) -- (init) ;
    \draw [-stealth, thick] (init) -- (setup) ;
  \end{tikzpicture}
  \caption{Organigramme d'exécution de la cible \texttt{teensy-3-1-it}}
  \labelFigure{sequenceDemarrageTeensySequentialSystick}
  \ligne
\end{figure}










\sectionLabel{Personalisation du démarrage}{personalisationDemarrageTeensy31it}

La cible définit la routine \plm+boot 0+ qui configure le micro-contrôleur.

Vous pouvez ajouter vos propres routines \plm+boot+. À chaque routine \plm+boot+ est associée une priorité d'exécution, qui doit être unique. Les routines \plm+boot+ sont exécutées dans l'ordre croissant des priorités, c'est-à-dire que la routine \plm+boot 0+ est exécutée la première.





\sectionLabel{Personalisation de l'initialisation}{personalisationInitTeensy31it}

La cible définit la routine \plm+init 0+ qui configure le \emph{SysTick Timer} pour qu'il engendre une interruption toutes les millisecondes.

Vous pouvez ajouter vos propres routines \plm+init+. À chaque routine \plm+init+ est associée une priorité d'exécution, qui doit être unique. Les routines \plm+init+ sont exécutées dans l'ordre croissant des priorités, c'est-à-dire que la routine \plm+init 0+ est exécutée la première.












\section{API}

L'API de la cible \texttt{teensy-3-1-it} partagent les routines en trois groupes :
\begin{itemize}
  \item les routines appelables dans tous les modes ;
  \item les routines appelables uniquement dans le mode \plm+`user+ (\refSubsectionPage{RoutinesTousModeTeensy31}) ;
  \item les routines appelables uniquement dans le mode \plm+`panic+ ;
\end{itemize}

\subsectionLabel{Routines appelables dans tous les modes}{RoutinesTousModeTeensy31}

Ces routines sont appelables dans les modes \plm+`user+, \plm+`isr+ et \plm+`panic+ :
\begin{itemize}
\item \texttt{ledOff} : \refSubsubsectionTitlePage{routineLedOffTeensy31it} ;
\item \texttt{ledOn} : \refSubsubsectionTitlePage{routineLedOnTeensy31it}.
\end{itemize}


\subsubsectionLabel{Routine \texttt{ledOff}}{routineLedOffTeensy31it}

\begin{PLM}
proc ledOff `user `panic `isr (?inLeds $uint32)
\end{PLM}

\subsubsectionLabel{Routine \texttt{ledOn}}{routineLedOnTeensy31it}

\begin{PLM}
proc ledOn `user `panic `isr (?inLeds $uint32)
\end{PLM}


\section{Les routines d'interruption}

Les \refTableau{tableItTeensySequentialSystick1}, \refTableau{tableItTeensySequentialSystick2} et \refTableau{tableItTeensySequentialSystick3} listent les interruptions définies par le processeur qui équipe la carte \emph{Teensy 3.1}. L'utilisateur peut définir une routine d'interruption pour chacune d'entre elles, sauf l'interruption n°1 (remise à zéro), et la n°15 (\texttt{SysTick}) qui est prise en charge de façon particulière (voir la \refSubsectionTitlePage{SystickPourTeensy31It}). Celle des autres interruptions est décrite dans les sections suivantes :
\begin{itemize}
  \item \refSubsectionTitlePage{itsTeensy31AvecExceptions} ;
  \item \refSubsectionTitlePage{itsTeensy31SansExceptions} ;
  \item \refSubsectionTitlePage{itsTeensyRoutinesUtilisateur}.
\end{itemize}


\begin{table}[!t]
  \centering
  \begin{tabular}{llllll}
    \textbf{Numéro}& \textbf{Nom routine} \\
    1  & \emph{ResetHandler, réservé par PLM} \\
    2  & \texttt{NMIHandler}\\
    3  & \texttt{HardFaultHandler}\\
    4  & \texttt{MemManageHandler}\\
    5  & \texttt{BusFaultHandler}\\
    6  & \texttt{UsageFaultHandler}\\
    7 à 10 & \emph{réservées par ARM} \\
    11 & \texttt{svcHandler}\\
    12 & \texttt{DebugMonitorHandler}\\
    13 & \emph{réservée par ARM} \\
    14 & \texttt{PendSVHandler}\\
    15 & \texttt{userSystickHandler}, voir \refSubsectionPage{SystickPourTeensy31It} \\
  \end{tabular}
  \caption{Table des interruptions 1 à 15 de la cible \texttt{teensy-3-1-it}}
  \labelTableau{tableItTeensySequentialSystick1}
  \ligne
\end{table}

\begin{table}[!t]
  \centering
  \begin{tabular}{llllll}
    \textbf{Numéro} & \textbf{Nom routine} \\
    16  & \texttt{DMAChannel0TranfertCompleteHandler}\\
    17  & \texttt{DMAChannel1TranfertCompleteHandler}\\
    18  & \texttt{DMAChannel2TranfertCompleteHandler}\\
    19  & \texttt{DMAChannel3TranfertCompleteHandler}\\
    20  & \texttt{DMAChannel4TranfertCompleteHandler}\\
    21  & \texttt{DMAChannel5TranfertCompleteHandler}\\
    22  & \texttt{DMAChannel6TranfertCompleteHandler}\\
    23  & \texttt{DMAChannel7TranfertCompleteHandler}\\
    24  & \texttt{DMAChannel8TranfertCompleteHandler}\\
    25  & \texttt{DMAChannel9TranfertCompleteHandler}\\
    26  & \texttt{DMAChannel10TranfertCompleteHandler}\\
    27  & \texttt{DMAChannel11TranfertCompleteHandler}\\
    28  & \texttt{DMAChannel12TranfertCompleteHandler}\\
    29  & \texttt{DMAChannel13TranfertCompleteHandler}\\
    30  & \texttt{DMAChannel14TranfertCompleteHandler}\\
    31  & \texttt{DMAChannel15TranfertCompleteHandler}\\
    32  & \texttt{DMAErrorHandler}\\
    33  & \emph{inutilisée} \\
    34  & \texttt{flashMemoryCommandCompleteHandler}\\
    35  & \texttt{flashMemoryReadCollisionHandler}\\
    36  & \texttt{modeControllerHandler}\\
    37  & \texttt{LLWUHandler}\\
    38  & \texttt{WDOGEWMHandler}\\
    39  & \emph{inutilisée} \\
    40  & \texttt{I2C0Handler}\\
    41  & \texttt{I2C1Handler}\\
    42  & \texttt{SPI0Handler}\\
    43  & \texttt{SPI1Handler}\\
    44  & \emph{inutilisée} \\
    45  & \texttt{CAN0MessageBufferHandler}\\
    46  & \texttt{CAN0BusOffHandler}\\
    47  & \texttt{CAN0ErrorHandler}\\
    48  & \texttt{CAN0TransmitWarningHandler}\\
    49  & \texttt{CAN0ReceiveWarningHandler}\\
    50  & \texttt{CAN0WakeUpHandler}\\
    51  & \texttt{I2S0TransmitHandler}\\
    52  & \texttt{I2S0ReceiveHandler}\\
    53 à 59  & \emph{inutilisées} \\
  \end{tabular}
  \caption{Table des interruptions 16 à 59 de la cible \texttt{teensy-3-1-it}}
  \labelTableau{tableItTeensySequentialSystick2}
  \ligne
\end{table}

\begin{table}[!t]
  \centering
  \begin{tabular}{llllll}
    \textbf{Numéro}& \textbf{Nom routine} \\
    60  & \texttt{UART0LONHandler}\\
    61  & \texttt{UART0StatusHandler}\\
    62  & \texttt{UART0ErrorHandler}\\
    63  & \texttt{UART1StatusHandler}\\
    64  & \texttt{UART1ErrorHandler}\\
    65  & \texttt{UART2StatusHandler}\\
    66  & \texttt{UART2ErrorHandler}\\
    67 à 72  & \emph{inutilisées} \\
    73  & \texttt{ADC0Handler}\\
    74  & \texttt{ADC1Handler}\\
    75  & \texttt{CMP0Handler}\\
    76  & \texttt{CMP1Handler}\\
    77  & \texttt{CMP2Handler}\\
    78  & \texttt{FMT0Handler}\\
    79  & \texttt{FMT1Handler}\\
    80  & \texttt{FMT2Handler}\\
    81  & \texttt{CMTHandler}\\
    82  & \texttt{RTCAlarmHandler}\\
    83  & \texttt{RTCSecondHandler}\\
    84  & \texttt{PITChannel0Handler}\\
    85  & \texttt{PITChannel1Handler}\\
    86  & \texttt{PITChannel2Handler}\\
    87  & \texttt{PITChannel3Handler}\\
    88  & \texttt{PDBHandler}\\
    89  & \texttt{USBOTGHandler}\\
    90  & \texttt{USBChargerDetectHandler}\\
    91 à 96  & \emph{inutilisées} \\
    97  & \texttt{DAC0Handler}\\
    98  & \emph{inutilisée} \\
    99  & \texttt{TSIHandler}\\
    100  & \texttt{MCGHandler}\\
    101  & \texttt{lowPowerTimerHandler}\\
    103  & \texttt{pinDetectPortAHandler}\\
    104  & \texttt{pinDetectPortBHandler}\\
    105  & \texttt{pinDetectPortCHandler}\\
    106  & \texttt{pinDetectPortDHandler}\\
    107  & \texttt{pinDetectPortEHandler}\\
    108 et 109  & \emph{inutilisées} \\
    110  & \texttt{softwareInterruptHandler}
  \end{tabular}
  \caption{Table des interruptions 60 à 110 de la cible \texttt{teensy-3-1-it}}
  \labelTableau{tableItTeensySequentialSystick3}
  \ligne
\end{table}


\subsectionLabel{Routines d'interruption par défaut, panique activée}{itsTeensy31AvecExceptions}

Quand la panique est activée, une routine par défaut est prédéfinie pour chaque interruption (sauf la n°1 et la n°15). Celle-ci exécute l'instruction \plm+panic+, dont l'argument est le numéro de l'interruption. Par exemple, pour l'interruption n°2 (\texttt{NMI}), la routine prédéfinie est :
\begin{PLM}[1]
proc NMIHandler `isr @nullWhenPanicDisabled @weak () {
  panic 2
}
\end{PLM}


\subsectionLabel{Routines d'interruption par défaut, panique inactivée}{itsTeensy31SansExceptions}

Quand la panique est inactivée, l'attribut \plm+@nullWhenPanicDisabled+ associé à chaque routine d'interruption provoque la suppression de cette routine d'interruption, et son remplacement de son adresse dans la table des vecteurs d'interruption par la valeur $0$.



\subsectionLabel{Routines d'interruption définies par l'utilisateur}{itsTeensyRoutinesUtilisateur}

L'attribut \plm+@weak+ associé à chaque routine d'interruption permet sa redéfinition par l'utilisateur. La routine par défaut est alors ignorée, que la panique soit activée ou non.

Par exemple, l'utilisateur peut définir la routine associée à \texttt{NMI} par :
\begin{PLM}[1]
proc NMIHandler `isr {
  ...
}
\end{PLM}

Il est important de conserver le nom. Si celui-ci est mal orthographié et ne correspond à aucune interruption :
\begin{itemize}
  \item la routine d'interruption par défaut est conservée (panique activée) ou supprimée (panique inactivée) ;
  \item un \emph{warning} est déclenché, signalant que la routine utilisateur est inutilisée.
\end{itemize}



\subsectionLabel{Routine associée à l'interruption \texttt{SysTick}}{SystickPourTeensy31It}

L'interruption \texttt{SysTick} est particulière. Elle est programmé par la routine \plm+init 0+ de façon à engendrer une interruption chaque milliseconde. Cette interruption se déclenche après la fin de l'exécution la routine \plm+init 0+, y compris éventuellement dans les routines \plm+init+ qui suivent. La routine d'interruption associée, inaccessible à l'utilisateur :
\begin{itemize}
  \item incrémente une variable globale de comptage du temps ;
  \item appelle la routine \plm+userSystickHandler+.
\end{itemize}

La routine \plm+userSystickHandler+ est définie par :
\begin{PLM}[1]
proc userSystickHandler `isr @weak () {
}
\end{PLM}

L'attribut \plm+@weak+ permet sa redéfinition par l'utilisateur.



