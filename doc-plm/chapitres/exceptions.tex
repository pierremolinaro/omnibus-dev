%!TEX encoding = UTF-8 Unicode
%!TEX root = ../doc-plm.tex





\chapter{Exceptions}


\begin{table}[ht]
\centering
%\small
\begin{tabular}{lp{7cm}l}
  \textbf{Numéros} & \textbf{Signification} & \textbf{Lien} \\
   < 0 & Exceptions liées aux vecteurs d'interruption & \\
   1 & Dépassement de capacité de l'incrémentation (\plm-++-) & \refSectionPage{instructionIncDec} \\
   2 & Dépassement de capacité de l'incrémentation (\plm+--+) & \refSectionPage{instructionIncDec} \\
   3 & Dépassement de capacité de la négation (\plm+-+) & \refSubsectionPage{negationOvf} \\
   4 & Dépassement de la construction d'un champ entier d'un registre (\plm+registre::champ (...)+) & \refSubsectionPage{constructionChampEntierRegistre}\\
   5 & Dépassement de capacité d'une conversion entre entiers (\plm+\+) & \refSectionPage{operateursInfixArithmétiques} \\
   10 & Dépassement de capacité de l'addition (\plm-+-) &  \refSectionPage{operateursInfixArithmétiques} \\
   11 & Dépassement de capacité de la soustraction (\plm+-+) & \refSectionPage{operateursInfixArithmétiques} \\
   12 & Dépassement de capacité de la multiplication (\plm+*+) & \refSectionPage{operateursInfixArithmétiques} \\
   13 & Dépassement de capacité de la division (\plm+/+) & \refSectionPage{operateursInfixArithmétiques} \\
   14 & Modulo par zéro (\plm+%+) & \refSectionPage{operateursInfixArithmétiques} \\
   20 & Échec de l'instruction \plm+assert+ & \refSectionPage{instructionAssert} \\
\end{tabular}
\caption{Code des exceptions}\index{Exception!Code}
\labelTableau{tableauCodeExceptions}
\end{table}






\sectionLabel{Définition des types liés aux exceptions}{typeLiesException}\index{exception:@\plm=exception:=}

Une exception est caractérisée par trois informations :
\begin{itemize}
  \item son code (\refTableauPage{tableauCodeExceptions}) ;
  \item le nom du fichier source de l'instruction qui a levé l'exception ;
  \item le numéro de ligne du fichier source de l'instruction qui a levé l'exception.
\end{itemize}

Le type du code et du numéro de ligne ne sont pas prédéfinis par le langage. La construction suivante définit ces types :
\begin{PLM}
exception : nomDuTypeDuCode nomDuTypeDuNumeroDeLigne
\end{PLM}

Par exemple, les numéros de code sont des entiers signés 32 bits, et les numéros de ligne des entiers non signés 32 bits :
\begin{PLM}
exception : $int32 $uint32
\end{PLM}

Cette construction doit apparaître exactement une fois. Normalement, c'est le fichier de définition de la cible qui la contient.


\sectionLabel{Routines exécutées lors de l'occurrence d'une exception}{routineException}

\begin{figure}[t]
  \centering
  \small
  \begin{tikzpicture}[
      cloud/.style ={draw=red, thick, ellipse,fill=red!20, minimum height=2em},
      block/.style ={rectangle, draw=blue, thick, fill=green!20, align=center},
      decision/.style={chamfered rectangle, draw=blue, thick, fill=green!20},
      node distance=5mm
    ]
    \node [cloud] (start) {\textsc{Occurrence d'une exception}} ;
    \node [block] (raz) [below=of start] {Masquage des interruptions} ;
    \node [block] (setup) [below=of raz] {Routines \texttt{\bf exception} \texttt{setup}} ;
    \node [block] (loop) [below=of setup] {Routines \texttt{\bf exception} \texttt{loop}} ;

    \draw [-stealth, thick] (start) -- (raz) ;
    \draw [-stealth, thick] (raz) -- (setup) ;
    \draw [-stealth, thick] (setup) -- (loop) ;
    \draw [-stealth, thick] (loop.south) -- +(0, -.25) -- +(2.75, -.25) -- +(2.75, 0.75)-- +(0, 0.75) ;
  \end{tikzpicture}
  \caption{Organigramme de la réponse à une exception}
  \labelFigure{sequenceException}
  \ligne
\end{figure}

Lors de l'occurrence d'une exception, l'exécution séquentielle des instructions est abandonnée, et :
\begin{itemize}
  \item les interruptions sont masquées, si elles ne le sont pas déjà ;
  \item les routines d'exception \texttt{setup} sont exécutées une fois ;
  \item les routines d'exception \texttt{loop} sont exécutées indéfiniment.
\end{itemize}
Ce fonctionnement est illustré à \refFigure{}{sequenceException}.

Si plusieurs routines d'exception \texttt{setup} sont définies, celles-ci sont exécutées dans l'ordre de leurs priorités relatives. Les routines d'exception \texttt{setup} offrent l'opportunité d'agir sur les sorties du micro-contrôleur, et d'afficher les caractéristiques de l'exception.

Si plusieurs routines d'exception \texttt{loop} sont définies, celles-ci sont exécutées dans l'ordre de leurs priorités relatives. Les routines d'exception \texttt{loop} permettent de signaler d'une manière répétitive l'occurrence d'une exception.

\subsectionLabel{Routines d'exception \texttt{setup} et \texttt{loop}}{routinesException}
\index{exception loop@\plm=exception loop=}
\index{exception setup@\plm=exception setup=}
\index{Routine!exception@\plm=exception=}

Leur syntaxe est la suivante :
\begin{PLM}
exception nom priorite {
  liste_instructions
}
\end{PLM}

\plm=nom= est soit \texttt{setup}, soit \texttt{loop}. \plm=priorite= est une constante entière, comprise entre $0$ et $2^{64}-1$. Si il y a plusieurs routines d'exception de même nom, elles sont exécutées dans l'ordre des priorités croissantes. Le compilateur vérifie que deux routines d'exception de même nom n'ont pas la même priorité.

\plm=liste_instructions= est une liste d'instructions qui n'a pas le droit d'engendrer d'exception. Toutes les opérations susceptibles de le faire sont donc interdites, et leur usage provoque une erreur de compilation. Par exemple, l'addition \plm=+= est interdite, il faut utiliser \plm=&+= à la place.

Trois constantes sont prédéfinies :
\begin{itemize}
  \item \plm=CODE=, qui contient le code de l'exception, et dont le type est défini par la construction \plm=exception:= (\refSectionPage{typeLiesException}) ;
  \item \plm=FILE=, qui contient le nom du fichier source de l'instruction qui a levé l'exception, et dont le type est \plm=StaticString= ;
  \item \plm=LINE=, qui contient le numéro de ligne du fichier source de l'instruction qui a levé l'exception, et dont le type est défini par la construction \plm=exception:= (\refSectionPage{typeLiesException}).
\end{itemize}

Les trois constantes \plm=CODE=, \plm=FILE= et \plm=LINE= permettent de signaler les caractéristiques de l'exception.


\section{Exemples}

Pour redémarrer un processeur ARMv7 lors d'une exception, on peut écrire la routine d'exception \texttt{setup} suivante :
\begin{PLM}
exception setup 255 {
  AIRCR = AIRCR::VECTKEY(0x5FA) | AIRCR::SYSRESETREQ
}
\end{PLM}
