%!TEX encoding = UTF-8 Unicode
%!TEX root = ../doc-plm.tex





\chapter{Panique organisée}


\begin{table}[ht]
\centering
%\small
\begin{tabular}{lp{10cm}l}
  \textbf{Numéros} & \textbf{Signification} & \textbf{Lien} \\
   7 & Échec de l'instruction \plm+assert+ & \refSectionPage{instructionAssert} \\
   8 & Dépassement de la construction d'un champ entier d'un registre (\plm+$registre {champ:xx}+) & \refSubsectionPage{constructionChampEntierRegistre}\\
   9 & Dépassement de capacité d'une conversion entre entiers (\plm+convert+) & \refSectionPage{operateursInfixArithmétiques} \\
   10 & Dépassement de capacité de l'addition (\plm-+-) &  \refSectionPage{operateursInfixArithmétiques} \\
   13 & Dépassement de capacité de la soustraction (\plm+-+) & \refSectionPage{operateursInfixArithmétiques} \\
   13 & Dépassement de capacité de la négation (\plm+-+) & \refSubsectionPage{negationOvf} \\
   33 & Dépassement de capacité de la multiplication (\plm+*+) & \refSectionPage{operateursInfixArithmétiques} \\
   39 & Dépassement de capacité de la division (\plm+/+) & \refSectionPage{operateursInfixArithmétiques} \\
   44 & Modulo par zéro (\plm+%+) & \refSectionPage{operateursInfixArithmétiques} \\
   $n$ & Exécution du vecteur d'interruption $n$ non implémenté & \\
\end{tabular}
\caption{Code des paniques}\index{Panique!Code}
\labelTableau{tableauCodePanique}
\end{table}






\sectionLabel{Définition des types liés à la panique}{typePanique}\index{panique:@\plm=panique:=}

Une panique est caractérisée par trois informations~:
\begin{itemize}
  \item son code (\refTableauPage{tableauCodePanique}) ;
  \item le nom du fichier source de l'instruction qui a levé la panique ;
  \item le numéro de ligne du fichier source de l'instruction qui a levé la panique.
\end{itemize}

Le type du code et du numéro de ligne ne sont pas prédéfinis par le langage. La construction suivante définit ces types~:
\begin{PLM}
panique : nomDuTypeDuCode nomDuTypeDuNumeroDeLigne
\end{PLM}

Par exemple, les numéros de code sont des entiers signés 32 bits, et les numéros de ligne des entiers non signés 32 bits~:
\begin{PLM}
panique : $int32 $uint32
\end{PLM}

Cette construction doit apparaître exactement une fois. Normalement, c'est le fichier de définition de la cible qui la contient.


\sectionLabel{Routines exécutées lors de l'occurrence d'une panique}{routinePanique}

\begin{figure}[t]
  \centering
  \small
  \begin{tikzpicture}[
      cloud/.style ={draw=red, thick, ellipse,fill=red!20, minimum height=2em},
      block/.style ={rectangle, draw=blue, thick, fill=green!20, align=center},
      decision/.style={chamfered rectangle, draw=blue, thick, fill=green!20},
      node distance=5mm
    ]
    \node [cloud] (start) {\textsc{Occurrence d'une panique}} ;
    \node [block] (raz) [below=of start] {Masquage des interruptions} ;
    \node [block] (setup) [below=of raz] {Routines \texttt{\bf proc panic} \texttt{setup}} ;
    \node [block] (loop) [below=of setup] {Routines \texttt{\bf proc panic} \texttt{loop}} ;

    \draw [-stealth, thick] (start) -- (raz) ;
    \draw [-stealth, thick] (raz) -- (setup) ;
    \draw [-stealth, thick] (setup) -- (loop) ;
    \draw [-stealth, thick] (loop.south) -- +(0, -.25) -- +(2.75, -.25) -- +(2.75, 0.75)-- +(0, 0.75) ;
  \end{tikzpicture}
  \caption{Organigramme de la réponse à une panique}
  \labelFigure{sequencePanique}
  \ligne
\end{figure}

Lors de l'occurrence d'une panique, l'exécution séquentielle des instructions est abandonnée, et~:
\begin{itemize}
  \item les interruptions sont masquées, si elles ne le sont pas déjà ;
  \item les routines de panique \texttt{setup} sont exécutées une fois ;
  \item les routines de panique \texttt{loop} sont exécutées indéfiniment.
\end{itemize}
Ce fonctionnement est illustré à \refFigure{}{sequencePanique}.

Si plusieurs routines de panique \texttt{setup} sont définies, celles-ci sont exécutées dans l'ordre de leurs priorités relatives. Les routines de panique \texttt{setup} offrent l'opportunité d'agir sur les sorties du micro-contrôleur, et d'afficher les caractéristiques de la panique.

Si plusieurs routines de panique \texttt{loop} sont définies, celles-ci sont exécutées dans l'ordre de leurs priorités relatives. Les routines de panique \texttt{loop} permettent de signaler d'une manière répétitive l'occurrence d'une panique.

\subsectionLabel{Routines de panique \texttt{setup} et \texttt{loop}}{routinesPanique}
\index{panic loop@\plm=panic loop=}
\index{panic setup@\plm=panic setup=}
\index{Routine!panic\plm=panic=}

Leur syntaxe est la suivante~:
\begin{PLM}
proc panic nom priorite {
  liste_instructions
}
\end{PLM}

\plm=nom= est soit \texttt{setup}, soit \texttt{loop}. \plm=priorite= est une constante entière, comprise entre $0$ et $2^{64}-1$. Si il y a plusieurs routines de panique de même nom, elles sont exécutées dans l'ordre des priorités croissantes. Le compilateur vérifie que deux routines de panique de même nom n'ont pas la même priorité.

\plm=liste_instructions= est une liste d'instructions qui n'a pas le droit d'engendrer de panique. Toutes les opérations susceptibles de le faire sont donc interdites, et leur usage provoque une erreur de compilation. Par exemple, l'addition \plm=+= est interdite, il faut utiliser \plm=&+= à la place.

Trois constantes sont prédéfinies~:
\begin{itemize}
  \item \plm=CODE=, qui contient le code de panique, et dont le type est défini par la construction \plm=panic:= (\refSectionPage{typePanique}) ;
  \item \plm=FILE=, qui contient le nom du fichier source de l'instruction qui a déclenché la panique, et dont le type est \plm=StaticString= ;
  \item \plm=LINE=, qui contient le numéro de ligne du fichier source de l'instruction qui a déclenché la panique, et dont le type est défini par la construction \plm=panique:= (\refSectionPage{typePanique}).
\end{itemize}

Les trois constantes \plm=CODE=, \plm=FILE= et \plm=LINE= permettent de signaler les caractéristiques de la panique.


\section{Exemples}

Pour redémarrer un processeur ARMv7 lors d'une panique, on peut écrire la routine de panique \texttt{setup} suivante~:
\begin{PLM}
panic proc setup 255 {
  AIRCR = $AIRCR {VECTKEY:0x5FA, SYSRESETREQ}
}
\end{PLM}
